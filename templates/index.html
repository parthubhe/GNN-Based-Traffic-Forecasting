<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Flow Prediction Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>

    <nav class="navbar">
        <div class="logo">MODEL_INTERFACE_v2.0</div>
        <div class="nav-links">
            <a href="#visualization-section">Visualization</a>
        </div>
    </nav>

    <div class="main-container">
        <h1>Traffic Forecast Model Analyzer</h1>
        <p>Select a model and a scenario to generate an interactive map visualization.</p>

        <div class="controls">
            <label for="model-selector">Select Model:</label>
            <select id="model-selector">
                {% if models %}
                    {% for model in models %}
                        <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                {% else %}
                    <option value="" disabled>No models found</option>
                {% endif %}
            </select>
        </div>
        
        <div class="viz-controls">
            <button class="viz-btn" data-viz="test_set">Test Set Performance</button>
            <button class="viz-btn" data-viz="gridlock">Gridlock Scenario</button>
            <button class="viz-btn" data-viz="rerouting">Rerouting Scenario</button>
        </div>

        <section id="visualization-section">
            <div id="map-container">
                <p>Select a model and scenario to begin.</p>
            </div>
            <div class="loader" id="loader"></div>
        </section>
    </div>

    <script>
        function generateVisualization(vizType) {
            const modelSelector = document.getElementById('model-selector');
            const modelName = modelSelector.value;
            const mapContainer = document.getElementById('map-container');
            const loader = document.getElementById('loader');

            if (!modelName) {
                mapContainer.innerHTML = "<p style='color: #ff4d4d;'>Please select a model from the dropdown.</p>";
                return;
            }

            loader.style.display = 'block';
            mapContainer.innerHTML = '';

            fetch('/visualize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model_name: modelName,
                    viz_type: vizType
                }),
            })
            .then(response => response.json())
            .then(data => {
                loader.style.display = 'none';
                if (data.error) {
                    mapContainer.innerHTML = `<p style='color: #ff4d4d;'>Error: ${data.error}</p>`;
                } else {
                    const iframe = document.createElement('iframe');
                    iframe.srcdoc = data.map_html;
                    iframe.style.width = '100%';
                    // <<< FIX: Set a fixed height for the iframe to ensure it's visible >>>
                    iframe.style.height = '600px'; 
                    iframe.style.border = 'none';
                    mapContainer.appendChild(iframe);
                }
            })
            .catch(error => {
                loader.style.display = 'none';
                mapContainer.innerHTML = `<p style='color: #ff4d4d;'>An unexpected error occurred: ${error}</p>`;
            });
        }

        document.querySelectorAll('.viz-btn').forEach(button => {
            button.addEventListener('click', () => {
                const vizType = button.getAttribute('data-viz');
                generateVisualization(vizType);
            });
        });
    </script>

</body>
</html>